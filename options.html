<html>
  <head>
    <title>OpenWith Settings</title>
    <style type="text/css">
      input[type=text] {
        border: solid 1px #000000;
        padding: 0.5em;
        border-radius: 7px;
        width: 51em;
      }

      textarea {
        width: 49em;
        height: 5em;
        border-radius: 7px;
      }

      .label-column {
        width: 11em;
      }

      .parser-section {
        border: solid 1px #000000;
      }

      .warning {
        color: red;
      }
    </style>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script type="text/javascript">
      var parserSectionCount = 1;
      function createParserSection(index, elem) {
        index = index || parserSectionCount;
        elem = elem || { domain: '', myfunction: '' };
        $("#parser-div").append(
          $('<div class="parser-section" id="parser-section-' + index + '"> \
              <table>\
                <tr>\
                  <td class="label-column">Domain:</td>\
                  <td><input type="text" class="domain" value="' + elem.domain + '" /></td>\
                </tr>\
                <tr>\
                  <td class="label-column">Parser Function:</td>\
                  <td>\
                  <tt>function(<a href="http://code.google.com/chrome/extensions/tabs.html#type-Tab">tab</a>) { </tt><br />\
                    <div style="float: left; width:1.5em">&nbsp;</div><textarea class="parser-function">' + elem.myfunction + '</textarea><br />\
                    <tt>} //Should return a relative path to the file you wish to open</tt>\
                  </td>\
                </tr>\
              </table>\
            </div>'));
        parserSectionCount++;
      }

      function restore() {
        $("#project-root").val(localStorage["project-root"] || "");
        $("#open-with-command").val(localStorage["open-with-command"] || "");
        var parserfunc = JSON.parse(localStorage["parser-functions"] || "[]");
        $(parserfunc).each(function(index, elem) {
          createParserSection(index, elem);
        });
      }

      function save() {
        localStorage["project-root"] = $("#project-root").val();
        localStorage["open-with-command"] = $("#open-with-command").val();
        var parserFunctions = [];
        $(".domain").each(function(index, elem) {
          var newEntry = { domain: elem.value };
          parserFunctions.push(newEntry);
        });
        $(".parser-function").each(function(index, elem) {
          parserFunctions[index].myfunction = elem.value;
        });
        localStorage["parser-functions"] = JSON.stringify(parserFunctions);
      }

      $(document).ready(function() {
        restore();
        $("#add-parser-section").click(function() { createParserSection(); });
        if(parserSectionCount == 1) {
          createParserSection();
        }
      });
    </script>
  </head>

  <body>
    <table>
      <tr><td colspan="2"><h2>OpenWith Settings</h2></td></tr>
      <tr>
        <td class="label-column">Project Root:</td>
        <td><input type="text" id="project-root" /></td>
      </tr>
      <tr>
        <td class="label-column">Open With Command:</td>
        <td>
          <span class="warning">WARNING: THIS WILL RUN THE PROCESS WITH THE
            SAME PERMISSIONS AS CHROME.<br />
            I WILL NOT CRY FOR YOU IF YOU PUT 'rm -rf /' IN HERE.</span><br />
          <input type="text" id="open-with-command" />
        </td>
      </tr>
      <tr><td colspan="2"><button id="add-parser-section">Add Parser Function</button></td></tr>
      <tr>
        <td colspan="2">
          <div id="parser-div"></div>
        </td>
      </tr>
    </table>
    <button onclick="save()">Save</button>
  </body>
</html>

